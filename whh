--[[

	AirHub WallHack (Reworked Core)
	CC0 1.0 Universal (2026)

]]

--// Cache
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local Vector2new = Vector2.new
local Vector3new = Vector3.new
local Color3fromRGB = Color3.fromRGB
local Drawingnew = Drawing.new
local WorldToViewportPoint = function(...)
	return Camera:WorldToViewportPoint(...)
end

--// Env
getgenv().AirHub = getgenv().AirHub or {}
if getgenv().AirHub.WallHack then return end

local WallHack = {
	WrappedPlayers = {},
	ServiceConnections = {}
}

getgenv().AirHub.WallHack = WallHack

--// Settings
WallHack.Settings = {
	Enabled = false,
	TeamCheck = false,
	AliveCheck = true
}

WallHack.Visuals = {
	ESP = {
		Enabled = true,
		Color = Color3fromRGB(255,255,255),
		Size = 14,
		Outline = true
	},
	Tracer = {
		Enabled = true,
		Type = 1,
		Color = Color3fromRGB(255,255,255),
		Thickness = 1
	},
	Box = {
		Enabled = true,
		Color = Color3fromRGB(255,255,255),
		Thickness = 1
	},
	HeadDot = {
		Enabled = true,
		Color = Color3fromRGB(255,255,255)
	},
	HealthBar = {
		Enabled = false
	}
}

--// Utils
local function GetRigType(char)
	if char:FindFirstChild("UpperTorso") then
		return "R15"
	elseif char:FindFirstChild("Torso") then
		return "R6"
	end
end

local function CreateDrawings()
	return {
		ESP = Drawingnew("Text"),
		Tracer = Drawingnew("Line"),
		Box = Drawingnew("Square"),
		HeadDot = Drawingnew("Circle"),
		Health = {
			Main = Drawingnew("Square"),
			Outline = Drawingnew("Square")
		}
	}
end

local function HideAll(d)
	d.Draw.ESP.Visible = false
	d.Draw.Tracer.Visible = false
	d.Draw.Box.Visible = false
	d.Draw.HeadDot.Visible = false
	d.Draw.Health.Main.Visible = false
	d.Draw.Health.Outline.Visible = false
end

--// Update
local function UpdatePlayer(d)
	local char = d.Character
	if not char then return end

	local hum = char:FindFirstChildOfClass("Humanoid")
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local head = char:FindFirstChild("Head")
	if not hum or not hrp or not head then return end

	if WallHack.Settings.AliveCheck and hum.Health <= 0 then
		HideAll(d)
		return
	end

	if WallHack.Settings.TeamCheck and d.Player.Team == LocalPlayer.Team then
		HideAll(d)
		return
	end

	local rootPos, onScreen = WorldToViewportPoint(hrp.Position)
	if not onScreen or not WallHack.Settings.Enabled then
		HideAll(d)
		return
	end

	-- ESP
	if WallHack.Visuals.ESP.Enabled then
		local esp = d.Draw.ESP
		esp.Visible = true
		esp.Text = d.Player.Name .. " [" .. math.floor((hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude) .. "]"
		esp.Size = WallHack.Visuals.ESP.Size
		esp.Color = WallHack.Visuals.ESP.Color
		esp.Outline = WallHack.Visuals.ESP.Outline
		esp.Center = true
		esp.Position = Vector2new(rootPos.X, rootPos.Y - 25)
	else
		d.Draw.ESP.Visible = false
	end

	-- Tracer
	if WallHack.Visuals.Tracer.Enabled then
		local tr = d.Draw.Tracer
		tr.Visible = true
		tr.Color = WallHack.Visuals.Tracer.Color
		tr.Thickness = WallHack.Visuals.Tracer.Thickness
		tr.From = Vector2new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
		tr.To = Vector2new(rootPos.X, rootPos.Y)
	else
		d.Draw.Tracer.Visible = false
	end

	-- Box
	if WallHack.Visuals.Box.Enabled then
		local box = d.Draw.Box
		box.Visible = true
		box.Color = WallHack.Visuals.Box.Color
		box.Thickness = WallHack.Visuals.Box.Thickness
		box.Filled = false

		local headPos = WorldToViewportPoint(head.Position + Vector3new(0,0.5,0))
		local legPos = WorldToViewportPoint(hrp.Position - Vector3new(0,3,0))
		local sizeY = math.abs(headPos.Y - legPos.Y)
		box.Size = Vector2new(sizeY/2, sizeY)
		box.Position = Vector2new(rootPos.X - box.Size.X/2, rootPos.Y - box.Size.Y/2)
	else
		d.Draw.Box.Visible = false
	end

	-- Head Dot
	if WallHack.Visuals.HeadDot.Enabled then
		local dot = d.Draw.HeadDot
		local hPos = WorldToViewportPoint(head.Position)
		dot.Visible = true
		dot.Color = WallHack.Visuals.HeadDot.Color
		dot.Radius = 4
		dot.Filled = true
		dot.Position = Vector2new(hPos.X, hPos.Y)
	else
		d.Draw.HeadDot.Visible = false
	end
end

--// Wrap
local function Wrap(player)
	if player == LocalPlayer or WallHack.WrappedPlayers[player] then return end

	local d = {
		Player = player,
		Character = nil,
		Draw = CreateDrawings()
	}

	WallHack.WrappedPlayers[player] = d

	player.CharacterAdded:Connect(function(char)
		d.Character = char
	end)

	d.Connection = RunService.RenderStepped:Connect(function()
		UpdatePlayer(d)
	end)
end

local function UnWrap(player)
	local d = WallHack.WrappedPlayers[player]
	if not d then return end

	if d.Connection then d.Connection:Disconnect() end
	for _,v in pairs(d.Draw) do
		if typeof(v) == "table" then
			for _,x in pairs(v) do pcall(function() x:Remove() end) end
		else
			pcall(function() v:Remove() end)
		end
	end

	WallHack.WrappedPlayers[player] = nil
end

--// Load
for _,p in ipairs(Players:GetPlayers()) do
	Wrap(p)
end

WallHack.ServiceConnections.PlayerAdded = Players.PlayerAdded:Connect(Wrap)
WallHack.ServiceConnections.PlayerRemoving = Players.PlayerRemoving:Connect(UnWrap)

--// Functions
WallHack.Functions = {}

function WallHack.Functions:Restart()
	for _,p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			UnWrap(p)
			Wrap(p)
		end
	end
end

function WallHack.Functions:Exit()
	for _,c in pairs(WallHack.ServiceConnections) do
		c:Disconnect()
	end
	for _,p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			UnWrap(p)
		end
	end
	getgenv().AirHub.WallHack = nil
end
